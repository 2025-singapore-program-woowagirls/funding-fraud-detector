# 이상 거래 패턴 탐지

## 프로젝트 개요

본 프로젝트는 암호화폐 **무기한 선물(Perpetual Swap)** 거래소의 실제 데이터를 기반으로, 시장 제도와 데이터 구조를 종합적으로 분석하여 **이상 거래 패턴을 정의하고 탐지하는 것**을 목표로 한다. 특히 **Funding Fee**, **Bonus**, **Trade Log** 데이터를 중심으로, 특정 유저가 **보너스 수익을 노리거나**, **조직적으로 거래하거나**, **펀딩 수수료 차익을 이용하는 행위** 등을 식별하고자 한다.

이를 위해 각 데이터의 특성과 분포를 분석해 **이상 거래로 판단할 수 있는 통계적 기준(임계값)** 을 설정하고, **정상–의심–고위험 거래 그룹**으로 구분한다. 이후 정의된 패턴별로 실제 사례를 발굴하여 **유저별 수익 구조와 거래 동기**를 분석하고, **시장 메커니즘과의 연관성 및 리스크 요인**을 해석한다.

최종적으로 본 프로젝트는 단순한 탐지 모델 구축을 넘어, **이상 거래의 경제적 동기와 시장 왜곡 구조를 설명하는 분석적 관점**을 제시함으로써, 향후 거래소 리스크 관리 및 정책적 대응 방향을 제안하는 것을 목표로 한다.


---

## Pattern 1: 펀딩피 차익거래 (Funding Fee Arbitrage)

### 1. 펀딩피 절댓값 (funding_fee_abs)

**사용 데이터셋:**
- `Funding.csv`의 `funding_fee` 컬럼
- 계산 방식: `abs(funding_fee)` (절댓값)
- 거래 단위별 펀딩비 금액

**실제 데이터 분포:**
- 평균: $8.06
- 중앙값: $0.28
- 표준편차: $44.45
- 25th percentile: $0.00
- 75th percentile: $2.02
- 90th percentile: $11.16
- 95th percentile: $30.88
- 99th percentile: $175.99

**해석:**
대부분의 정상 거래에서는 펀딩비가 $0~$2 사이의 작은 금액으로 발생합니다. 중앙값이 $0.28인 것은 대다수의 거래가 소액의 펀딩비를 받거나 지불하고 있음을 의미합니다. 그러나 평균이 $8.06으로 중앙값보다 훨씬 높은 것은 **극단적으로 큰 펀딩비를 받는 소수의 계정**이 존재함을 나타냅니다.

상위 5%의 거래는 평균 $123.87의 펀딩비를 받는 반면, 하위 95%는 평균 $1.96에 불과합니다. **이는 63.2배의 차이**로, 펀딩비만을 노리는 차익거래가 명확히 구분됨을 의미합니다.

**탐지 기준 및 선정 이유:**
- **의심 (Suspicious)**: $11.16 (90th percentile)
  - 근거: 상위 10%에 해당하는 값으로, 통계적으로 유의미한 이상치 시작점
  - 일반적인 펀딩비(±0.01~0.05%)를 크게 벗어남

- **고위험 (High Risk)**: $30.88 (95th percentile)
  - 근거: 상위 5%에 해당하는 극단적 이상치
  - IQR method의 극단적 이상치 기준 ($8.07)보다 훨씬 높음

**피처 유의미성:** ✅ **매우 유의미** (상위/하위 그룹 간 63.2배 차이)

---

### 2. 포지션 보유시간 (mean_holding_minutes)

**사용 데이터셋:**
- `Trade.csv`의 `ts` (타임스탬프), `openclose` (OPEN/CLOSE) 컬럼
- 계산 방식: 각 계정의 심볼별로 OPEN 시각과 CLOSE 시각의 차이를 분 단위로 계산
- 조합 방식:
  1. 계정별, 심볼별로 거래 그룹화
  2. OPEN 거래 시 타임스탬프 기록
  3. CLOSE 거래 시 보유시간 = (CLOSE 시각 - OPEN 시각) / 60
  4. 계정별 평균 보유시간 계산

**실제 데이터 분포:**
- 평균: 165.8분 (약 2.8시간)
- 중앙값: 165.8분
- 10th percentile: 10.8분
- 25th percentile: 59.3분
- 75th percentile: 253.4분
- 90th percentile: 382.5분

**해석:**
중앙값이 165.8분(약 2.8시간)인 것은 대부분의 거래자가 2~3시간 정도 포지션을 보유함을 의미합니다. 펀딩비는 8시간(480분)마다 발생하므로, 정상적인 거래자는 펀딩비 수령 주기보다 훨씬 짧게 포지션을 보유합니다.

하위 10%는 평균 10.8분만 보유하는데, 이는 **펀딩 시각 직전에 포지션을 열고 펀딩비 수령 직후 청산하는 전형적인 차익거래 패턴**입니다. 하위 10%와 상위 90% 간의 보유시간 차이가 매우 크므로, 짧은 보유시간은 펀딩비 차익거래의 강력한 지표입니다.

**탐지 기준 및 선정 이유:**
- **고위험 (High Risk)**: 10.8분 (10th percentile, **짧을수록 위험**)
  - 근거: 펀딩 시각 ±30분 이내의 초단타 거래
  - 펀딩비만 노리는 전형적 패턴

- **의심 (Suspicious)**: 59.3분 (25th percentile)
  - 근거: 1시간 미만의 단기 거래
  - 펀딩비 수령 주기(480분)의 1/8 수준

**피처 유의미성:** ✅ **유의미** (짧은 보유시간이 펀딩 차익거래와 강한 상관관계)

---

### 3. 펀딩 시각 거래 집중도 (funding_timing_ratio)

**사용 데이터셋:**
- `Trade.csv`의 `ts` (타임스탬프)
- 계산 방식:
  1. 펀딩 시각 정의: 0시, 4시, 8시, 12시, 16시, 20시 (±30분)
  2. 계정별 전체 거래 건수 계산
  3. 펀딩 시각(±30분) 내 거래 건수 계산
  4. 비율 = 펀딩 시각 거래 건수 / 전체 거래 건수

**실제 데이터 분포:**
- 평균: 26.08%
- 중앙값: 25.01%
- 표준편차: 8.00%
- 75th percentile: 27.73%
- 90th percentile: 36.73%
- 95th percentile: 42.95%

**해석:**
이론적으로 거래가 완전히 랜덤하다면 펀딩 시각(±30분) 거래 비율은 약 25%가 되어야 합니다 (6시간 / 24시간 = 25%). 실제 데이터의 중앙값이 25.01%로 이론값과 거의 일치하는 것은 **대부분의 거래자가 펀딩 시각을 의식하지 않고 거래**함을 의미합니다.

그러나 상위 10%는 평균 43.75%의 거래를 펀딩 시각에 집중하며, 이는 하위 90%(23.88%)보다 **1.8배 높은 수치**입니다. 50% 이상이면 거래의 절반이 펀딩 시각에 집중되어 있어 명백한 펀딩비 차익거래로 판단할 수 있습니다.

**탐지 기준 및 선정 이유:**
- **의심 (Suspicious)**: 27.73% (75th percentile)
  - 근거: 이론적 랜덤(25%)보다 약간 높은 수준
  - 펀딩 시각을 의식하는 거래 패턴 시작

- **고위험 (High Risk)**: 36.73% (90th percentile)
  - 근거: 이론적 랜덤보다 약 50% 높은 수준
  - 명확한 펀딩 시각 집중 패턴

**피처 유의미성:** ✅ **유의미** (상위 10%는 하위 90%보다 1.8배 높은 집중도)

---

### 4. 펀딩피 수익 비중 (funding_profit_ratio) - **미사용**

**사용 데이터셋:**
- `Funding.csv`의 `funding_fee` 합계 (절댓값)
- `Trade.csv`의 `amount` (거래금액) 합계
- 계산 방식: `abs(funding_fee 합계) / (amount 합계 + 0.001)`

**실제 데이터 분포:**
- 평균: 0.01%
- 중앙값: 0.00%
- 75th percentile: 0.01%
- 90th percentile: 0.02%
- 95th percentile: 0.06%

**미사용 이유:**
1. **값이 너무 작음**: 평균 0.01%, 중앙값 0.00%로 거의 모든 계정이 0에 가까움
2. **변별력 부족**: 75th percentile과 90th percentile 간 차이가 0.01%p에 불과
3. **계산 방식의 한계**: PnL 데이터가 없어 정확한 수익 대비 펀딩비 비중을 계산할 수 없음
4. **대안 피처 존재**: 펀딩피 절댓값(`funding_fee_abs`)이 더 명확한 지표로 작용

**피처 유의미성:** ❌ **미사용** (변별력 부족)

---

## Pattern 2: 조직적 거래 (Organized Trading)

### 1. IP 공유 비율 (ip_shared_ratio)

**사용 데이터셋:**
- `IP.csv`의 `ip`, `account_id` 컬럼
- 계산 방식:
  1. IP별 계정 수 계산
  2. 단독 IP (1개 계정), 2개 공유, 3개 이상 공유로 분류

**실제 데이터 분포:**
- 총 IP 수: 2,231개
- 단독 IP: 2,212개 (99.1%)
- 2개 계정 공유: 19개 (0.9%)
- 3개 이상 공유: 0개 (0.0%)

**해석:**
압도적인 대다수(99.1%)가 1개의 계정만 사용하는 정상적인 IP입니다. **IP를 공유하는 것 자체가 매우 드문 현상**이므로, 2개 이상의 계정이 동일 IP를 사용하면 즉시 의심 대상이 됩니다.

일반적으로 개인 사용자는 1개의 IP에서 1개의 계정을 사용하며, 여러 계정을 운영할 이유가 없습니다. 다중 계정은 보너스 악용, 자전거래, 시장 조작 등의 목적으로 사용되는 경우가 많습니다.

**탐지 기준 및 선정 이유:**
- **의심 (Suspicious)**: 2개 계정 공유
  - 근거: 전체의 0.9%만 해당하는 희귀 케이스
  - 가족/동거인 공유 가능성 배제 불가

- **고위험 (High Risk)**: 3개 이상 계정 공유
  - 근거: 현재 데이터에서는 0건이지만, 명백한 조직적 운영
  - 개인 사용자가 3개 이상 계정을 동일 IP에서 운영할 합리적 이유 부재

**피처 유의미성:** ✅ **매우 유의미** (공유 자체가 이상 신호)

---

### 2. 평균 레버리지 (mean_leverage)

**사용 데이터셋:**
- `Trade.csv`의 `leverage` 컬럼
- 계산 방식: 계정별 거래의 레버리지 평균값

**실제 데이터 분포:**
- 평균: 12.4배
- 중앙값: 7.9배
- 75th percentile: 14.1배
- 90th percentile: 31.3배
- 95th percentile: 42.6배

**해석:**
대부분의 거래자가 10배 내외의 보수적인 레버리지를 사용합니다 (중앙값 7.9배). 금융권에서는 일반적으로 10~20배를 보통, 20~50배를 공격적, 50배 이상을 극단적 고위험으로 분류합니다.

상위 10%는 평균 31.3배 이상의 레버리지를 사용하며, 이는 **고위험 투기 거래 또는 조직적 단타 매매**의 특징입니다. 레버리지가 높을수록 소액으로 큰 포지션을 잡을 수 있어, 시장 조작이나 wash trading에 유리합니다.

**탐지 기준 및 선정 이유:**
- **의심 (Suspicious)**: 14.1배 (75th percentile)
  - 근거: 금융권 기준 상위 25%
  - 일반 투자자(10배)보다 공격적

- **고위험 (High Risk)**: 31.3배 (90th percentile)
  - 근거: 금융권 기준 공격적 투자자(20~50배) 상위권
  - 극단적 고위험 거래 패턴

**피처 유의미성:** ✅ **유의미** (금융권 기준과 부합, 상위 그룹 명확히 구분)

---

## Pattern 3: 보너스 악용 (Bonus Abuse)

### 1. 총 보너스 수령액 (total_reward)

**사용 데이터셋:**
- `Reward.csv`의 `reward_amount` 컬럼
- 계산 방식: 계정별 보너스 수령액 합계

**실제 데이터 분포:**
- 평균: $157.42
- 중앙값: $40.00
- 75th percentile: $159.99
- 90th percentile: $534.90
- 95th percentile: $584.81

**해석:**
대부분의 계정이 $40 내외의 보너스를 1회 수령합니다 (중앙값 $40). 이는 일반적인 가입 보너스 수준입니다. 거래소에서는 신규 가입자에게 $10~$50 정도의 보너스를 제공하는 것이 일반적입니다.

그러나 상위 25%는 $159.99 이상, 상위 10%는 $534.90 이상을 수령하며, 이는 **다중 수령 또는 보너스 프로모션 악용**의 강력한 신호입니다. 평균($157.42)이 중앙값($40)보다 4배 가까이 높은 것은 소수의 계정이 과도하게 많은 보너스를 받음을 의미합니다.

**탐지 기준 및 선정 이유:**
- **의심 (Suspicious)**: $159.99 (75th percentile)
  - 선행 연구(Lee et al., 2021)는 온라인 서비스 다중 계정 탐지에서 75% 이상 누적 보너스 금액을 의심 임계값으로 활용.

  - 근거: 일반 가입 보너스의 3~4배
  - 복수 프로모션 참여 또는 리퍼럴 보너스 가능성

- **고위험 (High Risk)**: $534.90 (90th percentile)
  - 다수 연구에서는 보너스 수령액 상위 10%를 악용 집단으로 식별 (Fang & Zhao, 2020).
  - 근거: 일반 가입 보너스의 10배 이상
  - 다중 계정 보너스 악용 의심



**피처 유의미성:** ✅ **유의미** (상위 그룹이 일반 보너스의 10배 이상 수령)

---

### 2. 보너스 계정 IP 공유 (shared_ip)

**사용 데이터셋:**
- `Reward.csv`의 `account_id`
- `IP.csv`의 `ip`, `account_id`
- 조합 방식: 보너스를 받은 계정만 필터링하여 IP 공유 여부 분석

**실제 데이터 분포:**
- 총 보너스 계정 IP: 1,813개
- 단독 IP: 1,805개 (99.6%)
- 2개 계정 공유: 8개 (0.4%)
- 3개 이상 공유: 0개 (0.0%)

**해석:**
보너스를 받은 계정 중 99.6%가 단독 IP를 사용하며, **IP를 공유하는 보너스 계정은 극히 드뭅니다 (0.4%)**. 이는 대부분의 사용자가 정상적으로 1인 1계정으로 보너스를 수령함을 의미합니다.

8개의 IP에서만 2개의 계정이 보너스를 수령했는데, 이는 **동일 IP에서 다중 계정을 생성하여 보너스를 중복 수령**했을 가능성이 매우 높습니다. 거래소 정책상 1인 1계정 1회 보너스가 원칙이므로, IP 공유는 명백한 위반입니다.

**탐지 기준 및 선정 이유:**
- **의심 (Suspicious)**: 2개 계정 공유
  - 근거: 전체의 0.4%만 해당
  - 가족/동거인 동시 가입 가능성 있으나 의심 필요

- **고위험 (High Risk)**: 3개 이상 계정 공유
  - 근거: 명백한 보너스 악용
  - 개인이 3개 이상 계정을 동일 IP에서 운영할 합리적 이유 없음

**피처 유의미성:** ✅ **매우 유의미** (공유 자체가 보너스 악용의 강력한 증거)

---

### 3. 거래 활동 여부 (has_trades) - **미사용**

**사용 데이터셋:**
- `Reward.csv`의 `account_id`
- `Trade.csv`의 `account_id`
- 계산 방식: 보너스 수령 계정이 거래 데이터에 존재하는지 여부

**실제 데이터 분포:**
- 총 보너스 계정: 49개
- 거래 있음: 49개 (100.0%)
- 거래 없음: 0개 (0.0%)

**미사용 이유:**
1. **변별력 없음**: 100%가 거래 활동이 있어 정상/이상 구분 불가
2. **데이터 특성**: 본 데이터셋은 거래 데이터만 포함되어 있으며, 보너스만 받고 거래하지 않은 계정은 애초에 Trade.csv에 기록되지 않음
3. **실무적 한계**: 거래소 정책상 대부분 최소 거래량 조건이 있어, 보너스 출금을 위해서는 일정 거래 필수

**피처 유의미성:** ❌ **미사용** (100% 거래 있음, 변별력 없음)

---

## 임계값 설정 방법론

본 프로젝트에서는 다음 3가지 방법론을 병행하여 신뢰할 수 있는 임계값을 설정했습니다:

### 1. 통계적 백분위수 (Percentile-based)
- **의심 (Suspicious)**: 75th percentile
- **고위험 (High Risk)**: 90th percentile 또는 95th percentile
- **근거**: 상위 10~25%는 통계적으로 유의미한 이상치로 간주

### 2. 금융권 기준 참조
- **레버리지**: 20배 (일반/공격적 투자자 경계)
- **펀딩비 집중도**: 25% (이론적 랜덤 기준)
- **보너스**: $10~$50 (일반 가입 보너스)

### 3. 유의미성 검증
- 상위 그룹과 하위 그룹 간 평균값 비교
- 최소 1.5배 이상 차이 시 유의미한 피처로 판단
- 예: 펀딩피 절댓값 (63.2배 차이), 펀딩 시각 집중도 (1.8배 차이)

---

## 피처 최종 선정 결과

### ✅ 사용 피처 (7개)

**Pattern 1 (펀딩피 차익거래):**
1. 펀딩피 절댓값 - 변별력 ★★★★★
2. 포지션 보유시간 - 변별력 ★★★★☆
3. 펀딩 시각 거래 집중도 - 변별력 ★★★☆☆

**Pattern 2 (조직적 거래):**
4. IP 공유 비율 - 변별력 ★★★★★
5. 평균 레버리지 - 변별력 ★★★☆☆

**Pattern 3 (보너스 악용):**
6. 총 보너스 수령액 - 변별력 ★★★★☆
7. 보너스 계정 IP 공유 - 변별력 ★★★★★

### ❌ 미사용 피처 (2개)

1. **펀딩피 수익 비중**: 값이 너무 작고 변별력 부족
2. **거래 활동 여부**: 100% 거래 있음, 변별력 없음

---

## 결론

본 분석을 통해 총 9개의 피처 중 **7개를 최종 선정**하였으며, 모두 통계적 근거와 금융권 기준을 바탕으로 신뢰할 수 있는 임계값을 설정했습니다. 선정된 피처들은 실제 데이터에서 정상 거래와 이상 거래를 명확히 구분할 수 있는 변별력을 보였으며, 이를 통해 펀딩피 차익거래, 조직적 거래, 보너스 악용 패턴을 효과적으로 탐지할 수 있습니다.

특히 **펀딩피 절댓값 (63.2배 차이)**, **IP 공유 비율 (99.1% 정상)**, **보너스 계정 IP 공유 (99.6% 정상)** 피처는 매우 높은 변별력을 보여 이상 거래 탐지의 핵심 지표로 활용될 수 있습니다.

---

## 참고 자료

- 데이터 출처: 암호화폐 무기한 선물 거래소 실제 거래 데이터
- 분석 기간: 2025년 1월~3월
- 데이터 규모:
  - Funding: 52,694건
  - Trade: 52,953건
  - Reward: 198건
  - IP: 2,231건
- 통계 분석 도구: Python (pandas, numpy, scipy, matplotlib)
