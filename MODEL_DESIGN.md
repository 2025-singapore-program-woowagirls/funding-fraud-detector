# 이상 거래 탐지 모델 설계 문서 (Detection Model Design)

## 목차
- [개요](#개요)
- [피처 상관관계 분석](#피처-상관관계-분석)
- [모델 설계](#모델-설계)
- [검증 결과](#검증-결과)

---

## 개요

### 모델 목적
8개의 독립적인 피처를 사용하여 3가지 이상 거래 패턴을 탐지하고, 최종 리스크 점수(0~1)를 산출합니다.

### 설계 원칙
1. **통계적 임계값**: 데이터 기반 백분위수 (75th, 90th, 95th)
2. **도메인 지식**: 암호화폐 거래소 업계 표준 반영
3. **비선형 함수**: 지수, 역수, 계단 함수로 패턴 특성 반영
4. **가중치 설계**: 변별력과 도메인 중요도 기반

---

## 피처 상관관계 분석

### 1. 상관계수 행렬

```
                      펀딩피    보유시간   펀딩시각   펀딩수익   IP공유   레버리지   보너스   보너스IP
펀딩피 절댓값          1.000    0.035    0.233    0.134    0.316   -0.201   0.164    0.011
보유시간              0.035    1.000    0.161    0.132   -0.032    0.123  -0.049   -0.061
펀딩시각 집중도        0.233    0.161    1.000    0.210    0.247    0.007   0.399    0.304
펀딩피 수익비중        0.134    0.132    0.210    1.000    0.233   -0.143   0.263    0.125
IP 공유 계정수        0.316   -0.032    0.247    0.233    1.000   -0.030   0.167    0.466
평균 레버리지        -0.201    0.123    0.007   -0.143   -0.030    1.000  -0.153   -0.128
총 보너스            0.164   -0.049    0.399    0.263    0.167   -0.153   1.000    0.122
보너스 IP공유        0.011   -0.061    0.304    0.125    0.466   -0.128   0.122    1.000
```

### 2. 주요 발견사항

✅ **강한 상관관계 (|r| > 0.5)**: 없음
- 모든 피처가 독립적으로 작동

✅ **중간 상관관계 (0.3 < |r| ≤ 0.5)**:
- IP 공유 ↔ 보너스 IP 공유: 0.466 (동일 IP에서 다중 계정 사용 패턴)
- 펀딩 시각 집중 ↔ 총 보너스: 0.399 (연관성 있으나 독립적)

✅ **패턴 내부 상관관계**: 낮음
- Pattern 1 내부: r < 0.24
- Pattern 2 내부: r = -0.03
- Pattern 3 내부: r = 0.12

**결론**: 모든 피처를 독립적으로 사용 가능

---

## 모델 설계

### 1. 정규화 함수

#### (1) 선형 정규화 (Linear Normalization)
```python
def normalize_linear(value, threshold_low, threshold_high):
    if value <= threshold_low:
        return 0.0
    elif value >= threshold_high:
        return 1.0
    else:
        return (value - threshold_low) / (threshold_high - threshold_low)
```
- 사용처: 펀딩피 절댓값, 펀딩 시각 집중도, 총 보너스
- 특징: 임계값 사이에서 선형 증가

#### (2) 역수 정규화 (Inverse Normalization)
```python
def normalize_inverse(value, threshold_low, threshold_high):
    if value >= threshold_high:
        return 0.0
    elif value <= threshold_low:
        return 1.0
    else:
        return 1.0 - (value - threshold_low) / (threshold_high - threshold_low)
```
- 사용처: 포지션 보유시간
- 특징: **짧을수록 위험** (역비례)

#### (3) 지수 정규화 (Exponential Normalization)
```python
def normalize_exponential(value, threshold_suspicious, threshold_high, steepness=2.0):
    if value <= threshold_suspicious:
        return 0.0
    normalized = (value - threshold_suspicious) / (threshold_high - threshold_suspicious)
    normalized = min(max(normalized, 0), 1)
    return normalized ** steepness
```
- 사용처: 펀딩피 수익비, 레버리지
- 특징: 임계값 이상에서 **급격히 증가** (비선형)
- steepness: 2.0~2.5 (기울기 조절)

#### (4) 계단 함수 (Step Function)
```python
def normalize_step(value, threshold):
    return 1.0 if value >= threshold else 0.0
```
- 사용처: IP 공유, 보너스 IP 공유
- 특징: 명확한 이진 분류 (거래소 정책 위반)

---

### 2. Pattern 1: 펀딩피 차익거래 점수

#### 공식
```
FundingScore = 0.35 * S1 + 0.25 * S2 + 0.15 * S3 + 0.25 * S4
```

#### 피처 및 가중치

| 피처 | 정규화 | 임계값 | 가중치 | 근거 |
|------|--------|--------|--------|------|
| **S1: 펀딩피 절댓값** | 선형 | $11.16 ~ $30.88 | **0.35** | 변별력 63.2배, 가장 강력 |
| **S2: 보유시간** | 역수 | 10.8 ~ 59.3분 | **0.25** | 10분 이하 = 명백한 차익거래 |
| **S3: 펀딩 시각 집중** | 선형 | 27.73% ~ 36.73% | **0.15** | 보조 지표 (이론 25%) |
| **S4: 펀딩피 수익비** | 지수(2.5) | 10.05% ~ 37.38% | **0.25** | 변별력 12.09배, 수익 구조 |

#### 도메인 근거
- **S1**: BTC $80,000 기준 1 BTC 포지션 = $8 펀딩비, $30 이상은 대규모 차익거래
- **S2**: 스캘핑 15분~1시간, **10분 이하는 펀딩비 수령 목적**
- **S3**: 랜덤 거래는 25%, 36% 이상은 명백한 집중
- **S4**: 일반 트레이더는 거래 차익 >90%, **37% 이상은 펀딩비 헌터**

---

### 3. Pattern 2: 조직적 거래 점수

#### 공식
```
OrganizedScore = 0.65 * S1 + 0.35 * S2
```

#### 피처 및 가중치

| 피처 | 정규화 | 임계값 | 가중치 | 근거 |
|------|--------|--------|--------|------|
| **S1: IP 공유 계정수** | 계단 | 2개=0.5, 3개+=1.0 | **0.65** | 거래소 정책 명백한 위반 (99.1% 정상) |
| **S2: 평균 레버리지** | 지수(2.0) | 14.1 ~ 31.3배 | **0.35** | 금융 리스크 (CFTC 최대 10배) |

#### 도메인 근거
- **S1**: 바이낸스/바이빗 1인 1계정 정책 (KYC), IP 공유 = ToS 위반
- **S2**: 초보 2-3배, 안전 5-10배, 공격적 20-50배, **31.3배는 극단적 고위험**

---

### 4. Pattern 3: 보너스 악용 점수

#### 공식
```
BonusScore = 0.40 * S1 + 0.60 * S2
```

#### 피처 및 가중치

| 피처 | 정규화 | 임계값 | 가중치 | 근거 |
|------|--------|--------|--------|------|
| **S1: 총 보너스 수령액** | 선형 | $159.99 ~ $534.90 | **0.40** | 일반 $10-$50의 10배 이상 |
| **S2: 보너스 IP 공유** | 계단 | 2개=0.5, 3개+=1.0 | **0.60** | 명백한 다중 계정 보너스 악용 (99.6% 정상) |

#### 도메인 근거
- **S1**: 일반 가입 보너스 $10-$50, 대형 프로모션 $100-$600, **$535는 일반의 10배**
- **S2**: 거래소는 IP/디바이스/KYC로 보너스 중복 수령 방지, 동일 IP 보너스 = 악용

---

### 5. 최종 리스크 점수

#### 공식
```
FinalRiskScore = 0.40 * FundingScore + 0.35 * OrganizedScore + 0.25 * BonusScore
```

#### 가중치 근거

| 패턴 | 가중치 | 근거 |
|------|--------|------|
| 펀딩피 차익거래 | **0.40** | 가장 흔한 패턴, 4개 피처로 정밀 탐지 |
| 조직적 거래 | **0.35** | 명백한 정책 위반, 거래소 ToS 직접 위반 |
| 보너스 악용 | **0.25** | 명백한 정책 위반, 금전적 손실 직접 |

#### 위험도 등급

| 등급 | 점수 범위 | 조치 |
|------|-----------|------|
| **Critical** | ≥ 0.6 | 즉시 계정 정지, 조사 |
| **High** | 0.4 ~ 0.6 | 긴급 리뷰 필요 |
| **Medium** | 0.2 ~ 0.4 | 모니터링 강화 |
| **Low** | < 0.2 | 정상 |

---

## 검증 결과

### 1. 고위험 계정 탐지 결과

#### 전체 통계
- **총 계정 수**: 63개
- **Critical**: 1개 (1.6%)
- **High**: 3개 (4.8%)
- **Medium**: 17개 (27.0%)
- **Low**: 42개 (66.7%)

#### 고위험 탐지율
- **High + Critical**: 4개 (6.3%)
- 합리적인 탐지율 (너무 높지도, 낮지도 않음)

### 2. 고위험 계정 사례 분석

#### 사례 1: A_d444580218 (Critical, 점수 0.628)
```
패턴별 점수:
  - 펀딩 점수: 0.979 (극단적)
  - 조직적 점수: 0.325
  - 보너스 점수: 0.489

원본 피처:
  • 펀딩피 절댓값: $47.97 (평균의 5.7배)
  • 보유시간: 7.0분 (극단적 짧음)
  • 펀딩 시각 집중: 87.3% (이론 25%의 3.5배)
  • 펀딩피 수익비: 36.4% (일반 2%의 18배)
  • IP 공유: 2개
  • 총 보너스: $336.90
  • 보너스 IP 공유: 2개

판정: 펀딩비 차익거래 + 보너스 악용 복합 패턴
```

#### 사례 2: A_1f97e16953 (High, 점수 0.518)
```
패턴별 점수:
  - 펀딩 점수: 0.685
  - 조직적 점수: 0.698
  - 보너스 점수: 0.000

원본 피처:
  • 펀딩피 절댓값: $81.80 (평균의 9.7배)
  • 보유시간: 23.5분 (짧음)
  • 펀딩 시각 집중: 39.2% (이론의 1.6배)
  • IP 공유: 3개 (명백한 정책 위반)
  • 평균 레버리지: 20.5배

판정: 펀딩비 차익거래 + 조직적 거래 복합 패턴
```

### 3. 모델 합리성 검증

#### (1) 고위험 vs 저위험 비교
```
평균 펀딩피:
  - 고위험: $34.57
  - 전체: $8.40
  - 차이: 4.1배

평균 보유시간:
  - 고위험: 56.0분
  - 전체: 628.2분
  - 고위험이 11.2배 짧음

펀딩 시각 집중:
  - 고위험: 56.4%
  - 전체: 29.4%
  - 차이: 1.9배
```

#### (2) 점수 분포
```
최종 리스크 점수:
  - 고위험 평균: 0.511
  - 저위험 평균: 0.075
  - 차이: 6.82배

표준편차: 0.144 (적절한 변별력)
```

#### (3) 패턴 간 독립성
```
상관계수:
  - Funding ↔ Organized: 0.200
  - Funding ↔ Bonus: 0.257
  - Organized ↔ Bonus: 0.139

모두 0.3 미만 → 패턴들이 독립적으로 작동
```

### 4. 다중 패턴 탐지

**2개 이상 패턴에서 높은 점수 (≥0.3)**: 17개 계정 (27.0%)

대표 사례:
- **A_d444580218**: 펀딩(0.98) + 보너스(0.49) → Critical
- **A_1f97e16953**: 펀딩(0.69) + 조직적(0.70) → High
- **A_f96ede8d34**: 펀딩(0.40) + 조직적(0.33) + 보너스(0.70) → High

---

## 모델 강점

### 1. 통계적 근거
- ✅ 데이터 기반 백분위수 임계값
- ✅ 변별력 검증 (1.5배 이상 차이)
- ✅ 상관관계 분석으로 독립성 확인

### 2. 도메인 지식 통합
- ✅ 암호화폐 거래소 업계 표준 반영
- ✅ 실제 거래 패턴 (스캘핑, 펀딩 차익거래) 고려
- ✅ 거래소 정책 (1인 1계정, KYC) 준수 검증

### 3. 비선형 함수 활용
- ✅ 지수 함수: 급격한 위험 증가 (레버리지, 펀딩피 수익비)
- ✅ 역수 함수: 역비례 관계 (보유시간)
- ✅ 계단 함수: 명확한 정책 위반 (IP 공유)

### 4. 합리적인 탐지율
- ✅ 고위험: 6.3% (너무 높거나 낮지 않음)
- ✅ 고위험이 실제로 이상 피처 보유 (6.82배 높은 점수)
- ✅ 다중 패턴 탐지 가능 (27% 복합 패턴)

---

## 향후 개선 방향

### 1. 머신러닝 확장
- Random Forest, XGBoost로 자동 가중치 학습
- Isolation Forest로 이상치 탐지
- 라벨링된 데이터 축적 후 지도학습

### 2. 실시간 모니터링
- 스트리밍 데이터 처리
- 동적 임계값 조정 (시장 변동성 반영)
- 알림 시스템 통합

### 3. 추가 피처
- 거래 시간대 패턴
- 거래 빈도 (거래 간 간격)
- 포지션 크기 변화 패턴
- 디바이스 핑거프린트

---

## 참고 자료

### 코드 파일
- `1_feature_correlation_analysis.py`: 피처 상관관계 분석
- `2_design_detection_model.py`: 모델 설계 및 점수 계산
- `3_model_validation.py`: 모델 검증 및 분석

### 데이터 파일
- `all_features.csv`: 전체 피처 데이터
- `final_risk_scores.csv`: 최종 리스크 점수
- `high_risk_detailed.csv`: 고위험 계정 상세
- `multi_pattern_accounts.csv`: 다중 패턴 계정

### 시각화
- `feature_correlation_heatmap.png`: 피처 상관관계 히트맵
- `risk_score_distribution.png`: 점수 분포
- `model_validation_analysis.png`: 모델 검증 분석

---

**문서 버전**: 1.0
**작성일**: 2025-01-14
**모델 성능**: 고위험 6.3% 탐지, 정상 대비 6.82배 높은 점수
